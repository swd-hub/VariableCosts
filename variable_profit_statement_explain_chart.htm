<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<title>変動損益計算書</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f4f6f8;
  color: #333;
  margin: 30px;
}

h1 {
  font-size: 28px;
  margin-bottom: 20px;
  color: #2c3e50;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.08); /* 軽く奥行き */
}

table {
  table-layout: fixed;
  border-collapse: collapse;
  width: 100%;
  margin-bottom: 40px;
  background: linear-gradient(to bottom, #ffffff, #f8fafc);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 6px;
  /*overflow: hidden;*/
  
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

table:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15); /* 浮かせる影 */
}

caption {
  text-align: left;
  font-weight: bold;
  font-size: 22px;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #4daef0, #3498db);
  color: white;
  box-shadow: inset 0 -2px 0 rgba(255,255,255,0.2);
}

th, td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: right;
  font-size: 20px;
}

th:first-child, td:first-child {
  background: linear-gradient(to bottom, #f5f8fa, #e7ecef);
  text-align: left;
  font-weight: 600;
  width: 200px;
}

thead th {
  background: linear-gradient(to bottom, #f0f3f5, #dfe4e7);
  font-weight: 600;
  text-align: center;
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.05);
}

tbody tr:hover {
  background: linear-gradient(to bottom, #f9fcff, #eef6ff);
}

input[type="number"], input[type="text"] {
  width: 100px;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 20px;
  text-align: right;
  box-shadow: inset 1px 1px 3px rgba(0,0,0,0.05); /* 凹み感 */
  transition: box-shadow 0.2s ease, transform 0.2s ease;
}

input[type="number"]:focus, input[type="text"]:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(52,152,219,0.3), inset 1px 1px 3px rgba(0,0,0,0.05);
}

#control {
  margin-bottom: 20px;
}

#control button {
  padding: 6px 12px;
  background: linear-gradient(to bottom, #4daef0, #3498db);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 20px;
  margin-right: 10px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

#control button:hover {
  background: linear-gradient(to bottom, #5eb9f5, #2980b9);
  transform: translateY(-2px);
  box-shadow: 0 5px 10px rgba(0,0,0,0.2);
}

#control button:active {
  transform: translateY(0);
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

#fixedTotal {
  font-weight: bold;
  color: #2c3e50;
}

.summary-table {
  width: 100%;
  margin-bottom: 40px;
}

.summary-table th,
.summary-table td {
  text-align: left;
}

.summary-table input[type="number"] {
  width: 300px;
  box-sizing: border-box;
  font-size: 20px;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: right;
  box-shadow: inset 1px 1px 3px rgba(0,0,0,0.05);
}

.speak-on-hover {
  position: relative;
  cursor: pointer;
  overflow: visible; /* 念のため */
}

.speak-on-hover::after {
  content: attr(data-speech);
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  z-index: 9999;
  font-size: 0.8em;
  max-width: 300px; /* ← 横幅を広げる */
  white-space: normal; /* ← 折り返しを許可 */
  box-sizing: border-box;
  word-break: break-word; /* ← 長い単語も折り返し */
}
.speak-on-hover:hover::after {
  opacity: 1;
}
.tooltip-container {
  position: relative;
  overflow: visible;
}
.tooltip {
  position: absolute;
  top: -10px; /* 必要に応じて調整 */
  left: 100%;
  transform: translateX(-50%);
  z-index: 1000;
}

/* 経営全体合計の列幅を安定させる */
table#totalTable {
  table-layout: fixed;
  width: 100%;
  border-collapse: collapse;
}

/* 1列目（見出し）固定幅。必要なら後から個別に上書き可 */
table#totalTable th:first-child {
  width: 200px;
}

/* 見出し・データの整形（共通余白/枠でズレ防止） */
table#totalTable th,
table#totalTable td {
  padding: 8px 10px;
  border: 1px solid #ddd;
  white-space: nowrap;      /* 折返しでの行高変化を防止 */
}

/* 面積入力のはみ出し防止 */
table#totalTable input[type="number"] {
  width: 100px;
  box-sizing: border-box;
}

/* 共通の入力幅（例：セル一杯なら100%） */
#cropTable input[type="number"],
#costTable input[type="number"],
#totalTable input[type="number"] {
  width: 100%;          /* セル幅いっぱいに広げる */
  box-sizing: border-box;
}


</style>
</head>
<body>

<h1>変動損益計算書</h1>

<div id="control">
  <button onclick="addCrop()">作目を追加</button>
  <button onclick="downloadCSV()">入力データ保存</button>
  <input type="file" accept=".csv" onchange="uploadCSV(event)">
</div>

<!-- 作目別収入 -->
<table id="cropTable">
  <caption>作目別収入</caption>
  <thead>
    <tr id="cropHeader">
      <th>作目</th>
    </tr>
  </thead>
  <tbody>
    <tr><th>10a収量(kg)</th></tr>
    <tr><th>kg単価（円）</th></tr>
    <tr><th>10a販売額（円）</th></tr>
    <tr><th>10aその他収入（円）</th></tr>
    <tr><th>10a収入計（円）</th></tr>
  </tbody>
</table>

<!-- 変動費・限界利益 -->
<table id="costTable">
  <caption>10aあたり変動費、限界利益</caption>
  <tbody>
    <tr><th>10a資材費（円）</th></tr>
    <tr><th>10a作業委託費（円）</th></tr>
    <tr><th>10aその他変動費（円）</th></tr>
    <tr><th>10a変動費計（円）</th></tr>
    <tr><th>10a限界利益（円）</th></tr>
    <tr><th>限界利益率</th></tr>
  </tbody>
</table>

<!-- 面積との関係 -->
<table id="totalTable">
  <caption>面積との関係</caption>
  <tbody>
    <tr id="totalRow"><th>面積（a）</th></tr>
    <tr><th>収入（円）</th></tr>
    <tr><th>変動費計（円）</th></tr>
    <tr><th>限界利益（円）</th></tr>
    <tr><th>限界利益率(再掲)</th></tr>
  </tbody>
</table>


<!-- 固定費 -->
<table class="summary-table">
  <caption>固定費</caption>
  <tr><th>人件費（円）</th><td><input type="number" id="laborCost" value="" oninput="calculateFixedTotal()"></td></tr>
  <tr><th>減価償却費（円）</th><td><input type="number" id="depreciation" value="" oninput="calculateFixedTotal()"></td></tr>
  <tr><th>支払地代（円）</th><td><input type="number" id="landRent" value="" oninput="calculateFixedTotal()"></td></tr>
  <tr><th>その他固定費（円）</th><td><input type="number" id="otherFixed" value="" oninput="calculateFixedTotal()"></td></tr>
  <tr><th>固定費計（円）</th><td id="fixedTotal">–</td></tr>
</table>

<!-- 経営全体 -->
<table class="summary-table">
  <caption>経営全体</caption>
  <tr><th>販売額（円）</th><td id="sumSales">–</td></tr>
  <tr><th>その他収入（円）</th><td id="sumOtherIncome">–</td></tr>
  <tr><th>収入（円）</th><td id="sumRevenue">–</td></tr>
  <tr><th>変動費（円）</th><td id="sumVarCost">–</td></tr>
  <tr><th>限界利益（円）</th><td id="sumMargin">–</td></tr>
  <tr><th>費用（円）</th><td id="sumCostTotal">–</td></tr>
  <tr><th>利益（円）</th><td id="sumProfit">–</td></tr>
  <tr><th>損益分岐点の収入（円）</th><td id="sumBreakEven">–</td></tr>
</table>

<canvas id="stackedChart" width="800" height="400"></canvas>

<script>
let cropCount = 0;

function initCrops() {
  for (let i = 0; i < 5; i++) {
    addCrop();
  }
}
window.onload = initCrops;

function addCrop() {
  cropCount++;

  // === 作目ヘッダ列追加 ===
  const cropHeader = document.getElementById("cropHeader");
  const cropTh = document.createElement("th");
  const nameInput = document.createElement("input");
  nameInput.type = "text";
  nameInput.value = `作目${cropCount}`;
  nameInput.placeholder = "作目名";
  nameInput.style.width = "150px";
  cropTh.appendChild(nameInput);
  cropHeader.appendChild(cropTh);
  const colIndex = cropTh.cellIndex; // データ列のインデックス

  // === 作目別収入テーブルに列追加 ===
  document.querySelectorAll("#cropTable tbody tr").forEach((row, i) => {
    const td = document.createElement("td");
    if (i === 2 || i === 4) {
      // 自動計算で埋まる行は初期値として –
      td.textContent = "–";
    } else {
      const input = document.createElement("input");
      input.type = "number";
      input.oninput = () => calculateCrop(colIndex); // 入力時に再計算
      td.appendChild(input);
    }
    row.appendChild(td);
  });

  // === 変動費・限界利益テーブルに列追加 ===
  document.querySelectorAll("#costTable tbody tr").forEach((row, i) => {
    const td = document.createElement("td");
    if (i >= 3) {
      td.textContent = "–";
    } else {
      const input = document.createElement("input");
      input.type = "number";
      input.oninput = () => calculateCrop(colIndex);
      td.appendChild(input);
    }
    row.appendChild(td);
  });

  // === 経営全体合計テーブルに列追加 ===
  const totalRows = document.querySelectorAll("#totalTable tbody tr");

  // 面積行（先頭行）
  const areaTd = document.createElement("td");
  const areaInput = document.createElement("input");
  areaInput.type = "number";
  areaInput.placeholder = `面積${cropCount}`;
  areaInput.style.width = "100%"; // セル幅いっぱいに
  areaInput.oninput = calculateFixedTotal; // 入力時に再計算
  areaTd.appendChild(areaInput);
  totalRows[0].appendChild(areaTd);

  // 収入 / 変動費計 / 限界利益 / 限界利益率(再掲) にも列追加
  for (let r = 1; r < totalRows.length; r++) {
    const td = document.createElement("td");
    td.textContent = "–"; // 初期値
    totalRows[r].appendChild(td);
  }

  // 列数同期（不足/過剰セルの補正）
  syncTotalTable();
}


function renderCsvToTable(csvText, tableId) {
  const rows = csvText.trim().split(/\r?\n/).map(line =>
    line.split(',').map(cell => cell.replace(/^"|"$/g, '').trim())
  );

  const table = document.getElementById(tableId);
  if (!table) return;

  // thead
  let thead = table.querySelector('thead');
  if (!thead) {
    thead = document.createElement('thead');
    table.appendChild(thead);
  }
  thead.innerHTML = '';
  const headRow = document.createElement('tr');
  rows[0].forEach(text => {
    const th = document.createElement('th');
    th.textContent = text;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);

  // tbody
  let tbody = table.querySelector('tbody');
  if (!tbody) {
    tbody = document.createElement('tbody');
    table.appendChild(tbody);
  }
  tbody.innerHTML = '';
  for (let i = 1; i < rows.length; i++) {
    const tr = document.createElement('tr');
    rows[i].forEach(text => {
      const td = document.createElement('td');
      td.textContent = text || '–';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}


// totalTable の各行セル数を面積行に合わせる
function syncTotalTable() {
  const totalTable = document.getElementById("totalTable");
  const rows = totalTable.tBodies[0].rows;
  const targetCols = rows[0].cells.length; // 面積行の列数（th含む）

  for (let r = 1; r < rows.length; r++) {
    // 不足分を追加
    while (rows[r].cells.length < targetCols) {
      const td = document.createElement("td");
      td.textContent = "–";
      rows[r].appendChild(td);
    }
    // 過剰分を削る
    while (rows[r].cells.length > targetCols) {
      rows[r].deleteCell(-1);
    }
  }
}

function getInputValue(cell) {
  const input = cell.querySelector('input');
  return input ? parseFloat(input.value) || 0 : 0;
}

function calculateCrop(colIndex) {
  const cropRows = document.querySelectorAll("#cropTable tbody tr");
  const yieldCell = cropRows[0].cells[colIndex];
  const priceCell = cropRows[1].cells[colIndex];
  const salesCell = cropRows[2].cells[colIndex];
  const otherIncomeCell = cropRows[3].cells[colIndex];
  const totalIncomeCell = cropRows[4].cells[colIndex];
  const yieldVal = getInputValue(yieldCell);
  const priceVal = getInputValue(priceCell);
  const otherIncome = getInputValue(otherIncomeCell);
  const sales = yieldVal* priceVal;    //10a販売額か
  const totalIncome = sales + otherIncome;
  salesCell.textContent = sales.toFixed(0);
  totalIncomeCell.textContent = totalIncome.toFixed(0);

  const costRows = document.querySelectorAll("#costTable tbody tr");
  const materialCell = costRows[0].cells[colIndex];
  const laborCell = costRows[1].cells[colIndex];
  const otherCostCell = costRows[2].cells[colIndex];
  const totalCostCell = costRows[3].cells[colIndex];
  const marginCell = costRows[4].cells[colIndex];
  const marginRateCell = costRows[5].cells[colIndex];
  const material = getInputValue(materialCell);
  const labor = getInputValue(laborCell);
  const otherCost = getInputValue(otherCostCell);
  const totalCost = material + labor + otherCost;
  const margin = totalIncome - totalCost;
  const marginRate = totalIncome > 0 ? (margin / totalIncome) * 100 : 0;
  totalCostCell.textContent = totalCost.toFixed(0);
  marginCell.textContent = margin.toFixed(0);
  marginRateCell.textContent = marginRate.toFixed(1) + "%";
  calculateFixedTotal();
}

function setValByLabel(table, labelText, value) {
  for (const row of table.rows) {
    const labelCell = row.cells[0];
    if (labelCell && labelCell.textContent.trim() === labelText) {
      if (row.cells.length < 2) {
        row.insertCell(1);
      }
      row.cells[1].textContent =
        value !== null && value !== undefined && !isNaN(value)
          ? value.toLocaleString()
          : "–";
      break;
    }
  }
}


//表作成
function calculateFixedTotal() {
  let totalRevenue = 0;
  let totalVariableCost = 0;

  const cropRows = document.querySelectorAll("#cropTable tbody tr");
  const costRows = document.querySelectorAll("#costTable tbody tr");

  const totalTable = document.getElementById("totalTable");
  const totalTbodyRows = totalTable.tBodies[0].rows;
  const areaRow = totalTbodyRows[0];
  const revenueRow = totalTbodyRows[1];
  const varCostRow = totalTbodyRows[2];
  const marginRow = totalTbodyRows[3];
  const marginRateRow = totalTbodyRows[4];

  const areaInputs = areaRow.querySelectorAll("input[type='number']");

  // 各作目の集計
  areaInputs.forEach((input, idx) => {
    const area = parseFloat(input.value) || 0;
    const colIndex = idx + 1;

    const income10a = parseFloat(cropRows[4].cells[colIndex]?.textContent) || 0;
    const cost10a   = parseFloat(costRows[3].cells[colIndex]?.textContent) || 0;

    const factor = area /10;

    const revenue = income10a * factor; ////////////////////////////////////10a販売額
    
    const vcost   = cost10a   * factor;
    const margin  = revenue - vcost;
    const mrRate  = revenue > 0 ? (margin / revenue) * 100 : 0;

    if (revenueRow.cells[colIndex]) revenueRow.cells[colIndex].textContent = revenue ? revenue.toLocaleString() : "–";
    if (varCostRow.cells[colIndex]) varCostRow.cells[colIndex].textContent = vcost ? vcost.toLocaleString() : "–";
    if (marginRow.cells[colIndex])  marginRow.cells[colIndex].textContent  = margin ? margin.toLocaleString() : "–";
    if (marginRateRow.cells[colIndex]) marginRateRow.cells[colIndex].textContent = revenue ? mrRate.toFixed(1) + "%" : "–";

    totalRevenue     += revenue;
    totalVariableCost += vcost;
  });

  const totalMargin = totalRevenue - totalVariableCost;
  const marginRate = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;

  const labor = parseFloat(document.getElementById("laborCost").value) || 0;
  const depreciation = parseFloat(document.getElementById("depreciation").value) || 0;
  const landRent = parseFloat(document.getElementById("landRent").value) || 0;
  const otherFixed = parseFloat(document.getElementById("otherFixed").value) || 0;
  const fixedTotal = labor + depreciation + landRent + otherFixed;

  const profit = totalMargin - fixedTotal;
  const breakEvenRevenue = marginRate > 0 ? fixedTotal / (marginRate / 100) : 0;

  // 固定費合計の表示
  document.getElementById("fixedTotal").textContent = fixedTotal.toLocaleString();

  // ===== 経営全体テーブル更新（安全版） =====
  const managementTable = document.querySelectorAll(".summary-table")[1];
  if (managementTable) {
    // セルを安全にセットする関数
    const setVal = (rowIndex, value) => {
      if (managementTable.rows[rowIndex].cells.length < 2) {
        managementTable.rows[rowIndex].insertCell(1);
      }
      managementTable.rows[rowIndex].cells[1].textContent =
        value !== null && value !== undefined && !isNaN(value)
          ? value.toLocaleString()
          : "–";
    };

    // その他収入集計
    const totalOtherIncome = Array.from(areaInputs).reduce((sum, input, idx) => {
      const colIndex = idx + 1;
      const otherIncome10a = parseFloat(cropRows[3].cells[colIndex]?.querySelector("input")?.value) || 0;
      const area = parseFloat(input.value) || 0;
      return sum + (otherIncome10a * (area / 10));
    }, 0);

    // 販売額 = 総収入 - その他収入
    const totalSales = totalRevenue - totalOtherIncome;

    // 経営全体の各行を更新
    setVal(0, totalSales);                          // 販売額
    setVal(1, totalOtherIncome);                    // その他収入
    setVal(2, totalRevenue);                        // 収入
    setVal(3, totalVariableCost + fixedTotal);      // 費用
    setVal(4, totalVariableCost);                   // 変動費
    setVal(5, totalMargin);                         // 限界利益
    setVal(6, profit);                              // 利益
    setVal(7, breakEvenRevenue);                    // 損益分岐点
  }

  drawStackedChart();
}

// CSV出力
function tableToCSV() {
  let csv = [];
  document.querySelectorAll("table").forEach(table => {
    table.querySelectorAll("tr").forEach(row => {
      let rowData = [];
      row.querySelectorAll("th, td").forEach(cell => {
        let val = "";
        if (cell.querySelector("input")) {
          val = cell.querySelector("input").value;
        } else {
          val = cell.textContent;
        }
        if (val.includes(",") || val.includes("\n")) {
          val = `"${val}"`;
        }
        rowData.push(val);
      });
      csv.push(rowData.join(","));
    });
    csv.push("");
  });
  return csv.join("\n");
}

function downloadCSV() {
  const csvData = tableToCSV();

  // 現在日時の取得
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');

  // ファイル名を作成（秒は入れない）
  const fileName = `変動損益計算書_${year}${month}${day}_${hours}${minutes}.csv`;

  const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function uploadCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== "");
    let lineIndex = 0;

    document.querySelectorAll("table").forEach(table => {
      const rows = table.querySelectorAll("tbody tr, tr"); // tbody優先
      rows.forEach(row => {
        const cells = row.querySelectorAll("td, th");
        const values = (lines[lineIndex] || "").split(",");

        cells.forEach((cell, i) => {
          const input = cell.querySelector("input");
          if (input) {
            input.value = values[i] || "";
          }
        });

        lineIndex++;
      });
    });

    // ★ 各作目の再計算（cropCount が定義されている前提）
    for (let i = 1; i <= cropCount; i++) {
      calculateCrop(i);
    }

    // 固定費の合計なども再計算
    calculateFixedTotal();
  };

  reader.readAsText(file, "utf-8");
}



// 音声説明のイベント設定
function attachSpeechListeners() {
  document.querySelectorAll('.speak-on-hover').forEach(el => {
    el.addEventListener('mouseover', () => {
      speechSynthesis.cancel(); // 前の発声をキャンセル
      const utterance = new SpeechSynthesisUtterance(el.dataset.speech);
      utterance.lang = "ja-JP";
      utterance.rate = 1.6; // ← 読み上げ速度（1.0が標準、最大は10）
      speechSynthesis.speak(utterance);
    });
  });
}

// 初期読み込み時：表内に音声属性を追加
const speechMap = {
  "収入（円）": "収入は、変動費と固定費に利益を加えた金額と同額です",
  "10a収入計（円）": "10アール収入計は、10アール販売額（円）と10アールその他収入（円）の合計額です",  
  "10a限界利益（円）": "限界利益は、収入から変動費を引いた金額です",
  "限界利益（円）": "限界利益は、収入から変動費を引いた金額です",
  "10aその他収入（円）": "10アールその他収入は、面積に応じて変わる10アールのそのほかの収入です",
  "10a資材費（円）": "10アール資材費は、栽培こよみを見て計算した10アール分の資材費です",
  "10aその他変動費（円）": "10アールその他変動費は、面積に応じて変わるそのほかの変動費です",
  "10a変動費計（円）": "変動費は、面積に応じて変わる費用です",
  "変動費計（円）": "変動費は、面積に応じて変わる費用です",
  "限界利益率": "限界利益率は、収入額の中での限界利益の割合です",
  "人件費（円）": "人件費は、給与、賞与、役員報酬など労働への支払額です",  
  "減価償却費（円）": "ここでの減価償却費は、予測使用可能年数で計算しなおした減価償却費です",
  "支払地代（円）": "支払地代は、農地の賃借料など土地資源への支払額です",
  "その他固定費（円）": "その他固定費は、損益計算書から求めたそのほか固定費です",
  "利益（円）": "利益は、収入から変動費と固定費を引いた金額です",
  "損益分岐点の収入（円）": "収入が、損益分岐点の収入を下回ると赤字利益です"
  
};

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll("table").forEach(table => {
    table.querySelectorAll("tr").forEach(row => {
      row.querySelectorAll("th, td").forEach(cell => {
        const text = cell.textContent.trim();
        if (speechMap[text]) {
          cell.classList.add("speak-on-hover");
          cell.dataset.speech = speechMap[text];
        }
      });
    });
  });
  attachSpeechListeners();
});


// CSVファイル読み込み処理
document.querySelector('input[type="file"]').addEventListener('change', function () {
  const file = this.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const lines = e.target.result.split(/\r?\n/);
    let rowIndex = 0;
    document.querySelectorAll("table").forEach(table => {
      table.querySelectorAll("tr").forEach(row => {
        const cells = row.querySelectorAll("th, td");
        const values = (lines[rowIndex] || "").split(",");
        cells.forEach((cell, i) => {
          if (cell.querySelector("input")) {
            cell.querySelector("input").value = values[i] || "";
          } else {
            cell.textContent = values[i] || "";
          }

          // 音声説明を再付与
          const text = cell.textContent.trim();
          if (speechMap[text]) {
            cell.classList.add("speak-on-hover");
            cell.dataset.speech = speechMap[text];
          }
        });
        rowIndex++;
      });
      rowIndex++;
    });
    calculateFixedTotal();
    attachSpeechListeners(); // 音声イベントを再設定
  };

  reader.readAsText(file);
});

//描画
function drawStackedChart() {
  // 数値化ユーティリティ
  const getNum = (v) => {
    const s = String(v || "").replace(/,/g, "").trim();
    if (s === "" || s === "–") return 0;
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  };

  // 指定行・列のセルから、inputがあればvalue、なければtextContentを取得
  const getCellValue = (rows, r, c) => {
    const cell = rows[r]?.cells[c];
    if (!cell) return "";
    const inp = cell.querySelector("input");
    return inp ? inp.value : cell.textContent;
  };

  const cropRows   = document.querySelectorAll("#cropTable tbody tr");
  const costRows   = document.querySelectorAll("#costTable tbody tr");
  const areaInputs = document.querySelectorAll("#totalTable tbody tr:nth-child(1) input[type='number']");

  // 作目名（<input> or th.textContent）
  const cropNames = Array.from(document.querySelectorAll("#cropHeader th"))
    .slice(1)
    .map(th => {
      const inp = th.querySelector("input");
      return inp ? inp.value.trim() : th.textContent.trim();
    })
    .map(n => n || "未設定");

  let totalSales        = 0;
  let totalOtherIncome  = 0;
  let totalVariableCost = 0;
  const cropMargins     = [];

  // 面積でスケーリングして集計
  areaInputs.forEach((input, idx) => {
    const area    = getNum(input.value);
    const factor  = area / 10;
    const col     = idx + 1;

    // 各セルの値を取得
    const sales10a       = getNum(getCellValue(cropRows, 2, col));
    const otherInc10a    = getNum(getCellValue(cropRows, 3, col));
    const varCost10a     = getNum(getCellValue(costRows, 3, col));
    const margin10a      = getNum(getCellValue(costRows, 4, col));

    totalSales        += sales10a * factor ;　/////////10a販売額
    totalOtherIncome  += otherInc10a * factor;
    totalVariableCost += varCost10a * factor;
    cropMargins.push(margin10a * factor);
  });

  const revenue = totalSales + totalOtherIncome;
  const margin  = revenue - totalVariableCost;

  // 固定費集計
  const labor        = getNum(document.getElementById("laborCost")?.value);
  const depreciation = getNum(document.getElementById("depreciation")?.value);
  const landRent     = getNum(document.getElementById("landRent")?.value);
  const otherFixed   = getNum(document.getElementById("otherFixed")?.value);
  const fixedTotal   = labor + depreciation + landRent + otherFixed;

  const costTotal = totalVariableCost + fixedTotal;
  const profit    = margin - fixedTotal;

  // 既存チャートを破棄
  if (window.stackedChartInstance) window.stackedChartInstance.destroy();

  // グラフ描画
  const ctx = document.getElementById("stackedChart").getContext("2d");
  window.stackedChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["収入", "販売＋その他", "費用＋利益", "限界利益", "作目別限界利益"],
      datasets: [
        { label: "収入", data: [revenue, 0, 0, 0, 0], backgroundColor: "#4682b4" },
        { label: "販売額",       data: [0, totalSales, 0, 0, 0], backgroundColor: "#3cb371", stack: "bar2" },
        { label: "その他収入",   data: [0, totalOtherIncome, 0, 0, 0], backgroundColor: "#90ee90", stack: "bar2" },
        { label: "変動費",       data: [0, 0, totalVariableCost, totalVariableCost, totalVariableCost], backgroundColor: "#f08080" },
        { label: "固定費",       data: [0, 0, fixedTotal, 0, 0], backgroundColor: "#ffa07a" },
        { label: "利益",         data: [0, 0, profit, 0, 0], backgroundColor: "#87cefa" },
        { label: "限界利益（全体）", data: [0, 0, 0, margin, 0], backgroundColor: "#6495ed" },
        // 作目別限界利益
        ...cropMargins.map((val, i) => ({
          label: `${cropNames[i]} 限界利益`,
          data: [0, 0, 0, 0, val],
          backgroundColor: ["#ffd700", "#ffb6c1", "#dda0dd", "#98fb98", "#87ceeb"][i % 5]
        }))
      ]
    },
    options: {
      plugins: {
        legend:  { display: false },
        datalabels: {
          color: "#000",
          font: { weight: "bold", size: 11 },
          formatter: (value, ctx) => value
            ? `${ctx.dataset.label}\n${Math.round(value).toLocaleString()}円`
            : ""
        },
        title: {
          display: true,
          text: "農業経営の収支構成",
          font: { size: 20, weight: "bold" },
          padding: { top: 8, bottom: 12 }
        }
      },
      responsive: true,
      scales: {
        x: { stacked: true, categoryPercentage: 0.9, barPercentage: 1.0 },
        y: { stacked: true, beginAtZero: true, title: { display: true, text: "金額（円）" } }
      }
    },
    plugins: [ChartDataLabels]
  });

  // 損益分岐点計算
  const cmRatio            = revenue > 0 ? (margin / revenue) : 0;
  const breakEvenRevenue   = cmRatio > 0 ? (fixedTotal / cmRatio) : 0;

  // 経営全体表へ反映
  const setTxt = (id, val, frac = 0) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = frac > 0
      ? Number(val).toLocaleString(undefined, { maximumFractionDigits: frac })
      : Math.round(Number(val)).toLocaleString();
  };

  setTxt("sumSales",       totalSales);
  setTxt("sumOtherIncome", totalOtherIncome);   // ← ここに正しい値が入るようになります
  setTxt("sumRevenue",     revenue);
  setTxt("sumVarCost",     totalVariableCost);
  setTxt("sumMargin",      margin);
  setTxt("sumCostTotal",   costTotal);
  setTxt("sumProfit",      profit);
  setTxt("sumBreakEven",   breakEvenRevenue, 3);
}

// 入力変化で再描画
document.querySelectorAll("input, select, textarea")
  .forEach(el => el.addEventListener("input", drawStackedChart));

drawStackedChart();

</script>


</body>

</html>