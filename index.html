<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese/encoding.min.js"></script>

  <title>å˜ä½é¢ç©ã‚ãŸã‚Šå¤‰å‹•è²»è¨ˆç®—</title>
  <style>
body {
  font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
  background-color: #f7f9fc;
  color: #333;
  padding: 30px;
  line-height: 1.6;
}

h1 {
  font-size: 1.8em;
  color: #006c9c;
  margin-bottom: 20px;
}

table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;         /* åˆ—å¹…å›ºå®šãƒ¢ãƒ¼ãƒ‰ã§å‡ç­‰é…åˆ† */
  background-color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  margin-top: 20px;
  font-size: 14px;
}

th, td {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
  text-align: right;           /* å…¨ä½“å³æƒãˆï¼ˆæ–‡å­—åˆ—åˆ—ã¯JSã¾ãŸã¯HTMLå´ã§å·¦å¯„ã›å¯ï¼‰ */
  word-break: break-word;
}

th {
  background-color: #e3edf4;
  font-weight: bold;
  border-bottom: 2px solid #ccc;
}

/* å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ select */
th select {
  width: 100%;
  font-size: 13px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background-color: #fff;
  text-align: right;
}

/* å…¥åŠ›æ¬„ï¼ˆå›æ•°ãªã©ï¼‰ */
td input[type="number"] {
  width: 60px;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: right;
}

/* hoveræ™‚ã®å¼·èª¿ */
tr:hover td {
  background-color: #f4f8fc;
}

input[type="number"] {
  width: 70px;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
    text-align: right;
}
input[type="text"]::placeholder {
  color: #999;
}
input[type="text"] {
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  background-color: #007bb5;
  color: #fff;
  border: none;
  padding: 8px 14px;
  margin-right: 8px;
  font-size: 0.9em;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background-color: #005f8e;
}

#totalCost {
  font-size: 1.1em;
  margin-top: 15px;
  color: #444;
}

  </style>
</head>
<body>
  <h1>å˜ä½é¢ç©ã‚ãŸã‚Šå¤‰å‹•è²»è¨ˆç®—</h1>

  <!-- ğŸ”· file1ï¼šåŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆè³‡æä¾¡æ ¼ï¼‰ -->
  <section id="file1-area">
    <p>ğŸ“„ è³‡æä¾¡æ ¼ï¼ˆå“åãƒ»å®¹é‡ãƒ»å˜ä½ãƒ»äºˆç´„ä¾¡æ ¼ï¼‰</p>
    <button id="toggleTable1" style="display: inline;">â–¼ è¡¨ç¤ºã—ãªã„</button>
    <div id="table1" style="display: block;"></div>
  </section>

  <hr />

  <!-- ğŸ”· file2ï¼šä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¥åŠ›ï¼†è¨ˆç®—ï¼‰ -->
  <section id="file2-area">
    <p>ğŸ“„ ã“ã‚ˆã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆå“ç›®ãƒ»ä½¿ç”¨é‡ãƒ»å˜ä½ãƒ»å›æ•°ï¼‰</p>

    <div id="file2-controls" style="margin-bottom: 10px;">
      <input type="file" id="file2" accept=".csv" />
      <button id="toggleTable2" style="display: none;">è¡¨ã‚’è¡¨ç¤º</button> <!-- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º -->
      <button id="calcFile2" style="display: none;">è¨ˆç®—ã™ã‚‹</button>   <!-- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º -->
      <button id="toggleMoneyBtn" style="display: none;">é‡‘é¡ã‚ã‚Šã®ã¿è¡¨ç¤º</button> <!-- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º -->
      <button id="saveTable2CsvBtn" style="display: none;">è¡¨ã‚’ä¿å­˜</button>
    </div>

    <div id="totalCost" style="margin-bottom: 10px;">
      10ã‚¢ãƒ¼ãƒ«ã‚ãŸã‚Šå¤‰å‹•è²»ï¼š
      <span id="costPer10a">â€”</span> å††
      <button id="copyCostBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div id="table2" style="display: none;"></div> <!-- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º -->
  </section>

  <script>
  let masterData = {}; // å“å â†’ { usage, unit }
  let priceData = {}; // å“å â†’ { price, volume, unit }
    
window.addEventListener('DOMContentLoaded', () => {
  // file1ï¼ˆè³‡æä¾¡æ ¼ï¼‰ã®èª­ã¿è¾¼ã¿
  loadFile1ViaFetch(); // ã“ã®é–¢æ•°ã¯è³‡æä¾¡æ ¼.csvã‚’èª­ã¿è¾¼ã‚€ã®ã§æ®‹ã—ã¾ã™

  // file2ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  const file2Input = document.getElementById('file2');
  if (file2Input) {
    file2Input.addEventListener('change', handleFile2Load);
  } else {
    console.warn('âš ï¸ file2 ã® input ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
  }

  // âœ… è¡¨1 è¡¨ç¤ºåˆ‡æ›¿ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ç™»éŒ²
  const toggleTable1Btn = document.getElementById('toggleTable1');
  if (toggleTable1Btn) {
    toggleTable1Btn.style.display = 'inline'; // ğŸ”¥ â† ã“ã®1è¡Œè¿½åŠ ã§åˆæœŸè¡¨ç¤ºOK
    toggleTable1Btn.addEventListener('click', () => {
      const table1 = document.getElementById('table1');
      if (!table1) return;

      const isVisible = getComputedStyle(table1).display !== 'none';
      table1.style.display = isVisible ? 'none' : 'block';
      toggleTable1Btn.textContent = isVisible ? 'â–¶ è¡¨ã‚’è¡¨ç¤º' : 'â–¼ è¡¨ç¤ºã—ãªã„';
    });
  } else {
    console.warn('âš ï¸ toggleTable1 ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  // âœ… è¡¨2 è¡¨ç¤ºåˆ‡æ›¿ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ç™»éŒ²ï¼ˆã“ã“ã§ã¯åˆæœŸçŠ¶æ…‹ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
  // ãŸã ã—ã€handleFile2Loadã§è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯ãƒœã‚¿ãƒ³ã®å‚ç…§ã ã‘å–å¾—
  const toggleTable2Btn = document.getElementById('toggleTable2');
  if (toggleTable2Btn) {
    // åˆæœŸçŠ¶æ…‹ã¯CSSã§éè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹ã¯ãšãªã®ã§ã€ã“ã“ã§ã¯ç‰¹ã«æ“ä½œã—ãªã„
    // handleFile2Load å†…ã§è¡¨ç¤ºã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šã‚’è¡Œã†
  } else {
    console.warn('âš ï¸ toggleTable2 ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
});


  // â˜…ä¿®æ­£ç‚¹1: parseCSVã‹ã‚‰æœ«å°¾ã®ç©ºã‚»ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
  function parseCSV(content) {
    return content
      .trim()
      .split('\n')
      .map(row => row.split(',').map(cell => cell.trim()));
  }
    
ã€€function loadFile1ViaFetch() {
  fetch('./è³‡æä¾¡æ ¼.csv')
    .then(response => response.arrayBuffer()) // â† ãƒã‚¤ãƒŠãƒªå–å¾—
    .then(buffer => {
      const decoder = new TextDecoder('shift_jis'); // SJISãƒ‡ã‚³ãƒ¼ãƒ€ãƒ¼
      const csvText = decoder.decode(buffer);

      const rows = parseCSV(csvText); // æ—¢å­˜ã®CSVãƒ‘ãƒ¼ã‚µãƒ¼ä½¿ç”¨OK

      rows.slice(1).forEach(row => {
        // CSVãƒ˜ãƒƒãƒ€ãƒ¼: è²»ç›®,å“å,å®¹é‡,å˜ä½ï¼ˆã“ã‚ˆã¿è¡¨ç¤ºï¼‰,äºˆç´„å‚è€ƒä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰,å‚™è€ƒ
        const name = (row[1] || '').trim();
        const volume = parseFloat((row[2] || '').replace(/,/g, ''));
        const unit   = (row[3] || '').trim();
        const price  = parseFloat((row[4] || '').replace(/,/g, ''));

        if (name && !isNaN(price) && !isNaN(volume) && unit) {
          priceData[name] = { price, volume, unit };
        }
      });

      const table = createTableForFile1(rows);
      const tableDiv = document.getElementById('table1');
      tableDiv.innerHTML = '';
      tableDiv.appendChild(table);
      tableDiv.style.display = 'block';

      const toggleBtn = document.getElementById('toggleTable1');
      toggleBtn.style.display = 'inline';
      toggleBtn.textContent = 'â–¼ è¡¨ç¤ºã—ãªã„';
    })
    .catch(err => {
      alert('è³‡æä¾¡æ ¼.csv ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + err.message);
    });
}

function createTable(data) {
  const table = document.createElement('table');

  const headerRow = data[0];
  const calcColIndex = headerRow.indexOf('å›æ•°') + 1;

  const newHeader = [...headerRow];
  newHeader.splice(calcColIndex, 0, 'é‡‘é¡');

  const newData = data.slice(1).map(row => {
    const newRow = [...row];
    newRow.splice(calcColIndex, 0, '');
    return newRow;
  });

  const finalData = [newHeader, ...newData];

  const remarkColIndex = newHeader.indexOf('å‚™è€ƒ');
  const remarkValues = [...new Set(
    finalData.slice(1).map(row => row[remarkColIndex]).filter(v => v)
  )].sort();

  finalData.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');

    newHeader.forEach((colName, colIndex) => {
      const cellValue = row[colIndex] ?? '';
      const tag = rowIndex === 0 ? 'th' : 'td';
      const td = document.createElement(tag);
      td.style.textAlign = 'right';

      // âœ… 1è¡Œç›®ï¼šå‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆ
      if (rowIndex === 0 && colIndex === remarkColIndex) {
        const select = document.createElement('select');
        select.style.width = '100%';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'â–¼ å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼';
        select.appendChild(defaultOption);

        remarkValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = `â–¼ ${value}`;
          select.appendChild(option);
        });

        select.addEventListener('change', function () {
          const keyword = this.value;
          const allRows = table.querySelectorAll('tr');
          allRows.forEach((r, i) => {
            if (i === 0) return;
            const cell = r.querySelectorAll('td')[remarkColIndex];
            const text = cell?.textContent?.trim() || '';
            r.style.display = keyword === '' || text === keyword ? '' : 'none';
          });
        });

        td.appendChild(select);

      // âœ… 1è¡Œç›®ï¼šé‡‘é¡åˆ—ãƒ©ãƒ™ãƒ«
      } else if (rowIndex === 0 && colName === 'é‡‘é¡') {
        td.textContent = 'é‡‘é¡';

      // âœ… ãƒ‡ãƒ¼ã‚¿è¡Œï¼šå›æ•°åˆ—ï¼ˆå…¥åŠ›å¯èƒ½ï¼‰
      } else if (rowIndex > 0 && colName === 'å›æ•°') {
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.value = cellValue;
        input.style.width = '60px';
        input.style.textAlign = 'right';
        td.appendChild(input);

      // âœ… ãƒ‡ãƒ¼ã‚¿è¡Œï¼šï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡åˆ—ï¼ˆå…¥åŠ›å¯èƒ½ï¼ï¼‰
      } else if (rowIndex > 0 && colName === 'ï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡') {
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.step = 'any';
        input.value = cellValue;
        input.style.width = '80px';
        input.style.textAlign = 'right';
        td.appendChild(input);

      // âœ… ãƒ‡ãƒ¼ã‚¿è¡Œï¼šé‡‘é¡åˆ—
      } else if (rowIndex > 0 && colName === 'é‡‘é¡') {
        td.textContent = 'â€”';

      // âœ… ãã®ä»–ã®ã‚»ãƒ«ã¯ãã®ã¾ã¾è¡¨ç¤º
      } else {
        td.textContent = cellValue;
      }

      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  return table;
}

// â˜…ä¿®æ­£ç‚¹2: createTableForFile1ã®ãƒ«ãƒ¼ãƒ—æ¡ä»¶ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ—æ•°ã«ã™ã‚‹
function createTableForFile1(data) {
  const table = document.createElement('table');

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ—æ•°ã‚’å–å¾—ã—ã€ã“ã‚Œã‚’åŸºæº–ã«åˆ—ã‚’ç”Ÿæˆã™ã‚‹
  const numHeaderCols = data[0].length;

  // è²»ç›®åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆæƒ³å®šï¼šå…ˆé ­åˆ—ãŒè²»ç›®ï¼‰
  const categoryIndex = 0;

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè²»ç›®ä¸€è¦§ã‚’å–å¾—ï¼ˆç©ºæ¬„é™¤å¤–ï¼‰
  const categoryValues = [...new Set(data.slice(1).map(row => row[categoryIndex]).filter(v => v))].sort();

  data.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');

    // numHeaderCols ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ—æ•°åˆ†ã®ã‚»ãƒ«ãŒå¿…ãšç”Ÿæˆã•ã‚Œã¾ã™
    for (let colIndex = 0; colIndex < numHeaderCols; colIndex++) {
      const tag = rowIndex === 0 ? 'th' : 'td';
      const td = document.createElement(tag);
      td.style.textAlign = 'right';

      if (rowIndex === 0 && colIndex === categoryIndex) {
        // ğŸ”½ è²»ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã‚’æŒ¿å…¥
        const select = document.createElement('select');
        select.style.width = '100%';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'â–¼ è²»ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼';
        select.appendChild(defaultOption);

        categoryValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = `â–¼ ${value}`;
          select.appendChild(option);
        });

        select.addEventListener('change', function () {
          const keyword = this.value;
          const allRows = table.querySelectorAll('tr');
          allRows.forEach((r, i) => {
            if (i === 0) return;
            const cell = r.querySelectorAll('td')[categoryIndex];
            const text = cell?.textContent?.trim() || '';
            r.style.display = keyword === '' || text === keyword ? '' : 'none';
          });
        });

        td.appendChild(select);
      } else {
        // row[colIndex]ãŒundefinedã®å ´åˆã§ã‚‚ ?? '' ã§ç©ºæ–‡å­—åˆ—ãŒå…¥ã‚‹ãŸã‚ã€ç©ºã®ã‚»ãƒ«ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™
        td.textContent = row[colIndex] ?? '';
      }

      tr.appendChild(td);
    }

    table.appendChild(tr);
  });

  return table;
}



function handleFile2Load(e) {
  const file = e.target.files[0];
  const toggleTable2Btn = document.getElementById('toggleTable2');
  const calcBtn = document.getElementById('calcFile2');
  const moneyBtn = document.getElementById('toggleMoneyBtn');
  const saveBtn = document.getElementById('saveTable2CsvBtn');
  const table2Div = document.getElementById('table2'); // è¿½åŠ : table2Divã®å‚ç…§ã‚’å–å¾—

  if (!file) {
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã€å…¨ã¦ã®é–¢é€£ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    if (toggleTable2Btn) toggleTable2Btn.style.display = 'none';
    if (calcBtn) calcBtn.style.display = 'none';
    if (moneyBtn) moneyBtn.style.display = 'none';
    if (saveBtn) saveBtn.style.display = 'none';
    if (table2Div) table2Div.style.display = 'none'; // table2Divã‚‚éè¡¨ç¤ºã«ã™ã‚‹
    file2OriginalName = '';
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã—ã¦ä¿å­˜ï¼ˆsaveTable2CsvBtnã§åˆ©ç”¨ï¼‰
  file2OriginalName = file.name.replace(/\.csv$/i, '');


  const reader = new FileReader();

  reader.onload = function () {
    const rows = parseCSV(reader.result).filter(r => r.length > 0 && r[0]);

    if (rows.length === 0) {
      alert("âš ï¸ file2 ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼");
      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€å…¨ã¦ã®é–¢é€£ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      if (toggleTable2Btn) toggleTable2Btn.style.display = 'none';
      if (calcBtn) calcBtn.style.display = 'none';
      if (moneyBtn) moneyBtn.style.display = 'none';
      if (saveBtn) saveBtn.style.display = 'none';
      if (table2Div) table2Div.style.display = 'none'; // table2Divã‚‚éè¡¨ç¤ºã«ã™ã‚‹
      return;
    }

    const header = rows[0];
    const body = rows.slice(1).map(row => {
      const name = row[0];
      const currentUsage = row[1];
      const currentUnit = row[2];
      const fallback = masterData[name] || {};

      row[1] = currentUsage || (fallback.usage != null ? fallback.usage : '');
      row[2] = currentUnit || fallback.unit || '';

      return row;
    });

    const table = createTable([header, ...body]);
    const container = document.getElementById('table2');
    container.innerHTML = '';
    container.appendChild(table);
    container.style.display = 'block';

    // âœ… è¡¨2ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆtoggleTable2ï¼‰è¡¨ç¤ºï¼†ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    if (toggleTable2Btn) {
      toggleTable2Btn.style.display = 'inline-block';
      toggleTable2Btn.textContent = 'â–¼ è¡¨ç¤ºã—ãªã„';

      // â˜…ä¿®æ­£ç‚¹3: æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚ï¼‰
      if (toggleTable2Btn._eventListener) {
          toggleTable2Btn.removeEventListener('click', toggleTable2Btn._eventListener);
      }

      const newToggleListener = () => {
          const table2 = document.getElementById('table2');
          const calcBtnRef = document.getElementById('calcFile2'); // calcBtnã®å‚ç…§ã‚’å†åº¦å–å¾—
          if (!table2) return;

          const isVisible = getComputedStyle(table2).display !== 'none';
          table2.style.display = isVisible ? 'none' : 'block';
          toggleTable2Btn.textContent = isVisible ? 'â–¶ è¡¨ã‚’è¡¨ç¤º' : 'â–¼ è¡¨ç¤ºã—ãªã„';

          if (calcBtnRef) {
              // è¡¨ãŒéè¡¨ç¤ºã«ãªã‚‹å ´åˆã€è¨ˆç®—ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤ºã«
              // è¡¨ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã€è¨ˆç®—ãƒœã‚¿ãƒ³ã‚‚è¡¨ç¤ºã«
              calcBtnRef.style.display = isVisible ? 'none' : 'inline-block';
          }
      };
      toggleTable2Btn.addEventListener('click', newToggleListener);
      toggleTable2Btn._eventListener = newToggleListener; // ãƒªã‚¹ãƒŠãƒ¼å‚ç…§ã‚’ä¿å­˜
    }

    // âœ… é‡‘é¡åˆè¨ˆåˆæœŸåŒ–
    const costSpan = document.getElementById('costPer10a');
    if (costSpan) costSpan.textContent = 'â€”';

    // âœ… è¨ˆç®—ãƒœã‚¿ãƒ³è¡¨ç¤º
    if (calcBtn) calcBtn.style.display = 'inline-block';

    // âœ… é‡‘é¡ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼†ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆå®‰å…¨å‡¦ç†ï¼‰
    if (moneyBtn) {
        moneyBtn.style.display = 'inline-block';
        moneyBtn.textContent = 'â–¶ é‡‘é¡ã‚ã‚Šã®ã¿è¡¨ç¤º'; // åˆæœŸãƒ†ã‚­ã‚¹ãƒˆè¨­å®š

        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        if (moneyBtn._eventListener) {
            moneyBtn.removeEventListener('click', moneyBtn._eventListener);
        }

        let showOnlyPriced = false; // å„ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¹ã‚³ãƒ¼ãƒ—ã‚’èª¿æ•´

        const moneyBtnClickHandler = () => {
            const tableEl = document.querySelector('#table2 table');
            if (!tableEl) return;

            const headers = Array.from(tableEl.querySelectorAll('th')).map(th => th.textContent.trim());
            const priceIndex = headers.indexOf('é‡‘é¡');
            if (priceIndex === -1) return;

            showOnlyPriced = !showOnlyPriced;

            const rows = tableEl.querySelectorAll('tr');
            rows.forEach((tr, i) => {
                if (i === 0) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                const text = tr.querySelectorAll('td')[priceIndex]?.textContent.trim() ?? '';
                
                // â˜… ä¿®æ­£: æ•°å€¤ã«å¤‰æ›ã—ã€0ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿è¡¨ç¤ºã™ã‚‹
                const numericValue = parseFloat(text.replace(/,/g, '')); // ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦æ•°å€¤ã«å¤‰æ›
                const isDisplayable = numericValue > 0; // æ•°å€¤ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã®ã¿è¡¨ç¤º

                tr.style.display = (!showOnlyPriced || isDisplayable) ? '' : 'none';
            });

            moneyBtn.textContent = showOnlyPriced ? 'â–¼ å…¨ã¦è¡¨ç¤ºã™ã‚‹' : 'â–¶ é‡‘é¡ã‚ã‚Šã®ã¿è¡¨ç¤º';
        };

        moneyBtn.addEventListener('click', moneyBtnClickHandler);
        moneyBtn._eventListener = moneyBtnClickHandler; // å‚ç…§ã‚’ä¿å­˜
    } else {
        console.warn("âš ï¸ toggleMoneyBtn ãŒ DOM ã«å­˜åœ¨ã—ã¦ã„ã¾ã›ã‚“");
    }

    // file2ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã€Œè¡¨ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
    if (saveBtn) {
        saveBtn.style.display = 'inline-block';
    }
  };

  reader.readAsText(file, 'Shift_JIS');
}


// document.getElementById('toggleTable2').addEventListener('click', function () { ... }); ã‚’å‰Šé™¤

document.getElementById('calcFile2').addEventListener('click', function () {
  const table = document.querySelector('#table2 table');
  if (!table) {
    alert('âš ï¸ è¡¨ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }

  const headers = Array.from(table.querySelector('tr').querySelectorAll('th')).map(th => th.textContent);
  const idx = {
    name: headers.indexOf('å“å'),
    amountPer10a: headers.indexOf('ï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡'),
    unit: headers.indexOf('å˜ä½'),
    count: headers.indexOf('å›æ•°'),
    price: headers.indexOf('é‡‘é¡')
  };

  const rows = Array.from(table.querySelectorAll('tr')).slice(1);
  let total = 0;

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const name = cells[idx.name]?.textContent.trim();

    // ã€Œï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡ã€ã¨ã€Œå›æ•°ã€ã¯inputã®å€¤ã‚’å–å¾—
    const amountInput = cells[idx.amountPer10a]?.querySelector('input');
    const amountPer10a = parseFloat(amountInput?.value || 0);
    const unit = cells[idx.unit]?.textContent.trim();
    const countInput = cells[idx.count]?.querySelector('input');
    const count = parseFloat(countInput?.value || 0);
    const priceCell = cells[idx.price];

    const info = priceData[name];
    if (!info || isNaN(info.price) || isNaN(info.volume)) {
      priceCell.textContent = 'â€•'; // æƒ…å ±ãŒãªã„ã€ã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯ãƒã‚¤ãƒ•ãƒ³
      return;
    }

    if (unit !== info.unit) {
      priceCell.textContent = 'å˜ä½ä¸ä¸€è‡´'; // å˜ä½ä¸ä¸€è‡´ã®å ´åˆ
      return;
    }

    const unitPrice = info.price / info.volume;
    const amount = unitPrice * amountPer10a * count;
    
    // é‡‘é¡ãŒ0ã®å ´åˆã‚‚0ã¨è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
    if (isNaN(amount)) {
      priceCell.textContent = 'â€•';
    } else if (amount === 0) {
      priceCell.textContent = '0'; // 0å††ã®å ´åˆã¯ã€Œ0ã€ã¨è¡¨ç¤º
    } else {
      priceCell.textContent = amount.toLocaleString();
    }

    if (count > 0 && !isNaN(amount)) {
      total += amount;
    }
  });

  const costSpan = document.getElementById('costPer10a');
  if (costSpan) costSpan.textContent = Math.round(total).toLocaleString();
});

// `showOnlyPriced` å¤‰æ•°ã¯ `handleFile2Load` å†…ã§ã‚¹ã‚³ãƒ¼ãƒ—ã•ã‚Œã¦ãŠã‚Šã€
// ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ™‚ã«ç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã—ãŸã€‚

//å¤‰å‹•è²»ã®ã‚³ãƒ”ãƒ¼
document.getElementById('copyCostBtn')?.addEventListener('click', () => {
  const raw = document.getElementById('costPer10a')?.textContent?.trim();
  if (raw && raw !== 'â€•') {
    const numericValue = raw.replace(/,/g, '');
    navigator.clipboard.writeText(numericValue)
      .then(() => alert('å¤‰å‹•è²»ã®æ•°å€¤ã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))
      .catch(() => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'));
  }
});



//ä¿å­˜
let file2OriginalName = ''; // â† ãƒ•ã‚¡ã‚¤ãƒ«åä¿æŒç”¨ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰

// file2 ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ DOMContentLoaded å†…ã§ handleFile2Load ã«ç´ä»˜ã‘æ¸ˆã¿
// ãã®ãŸã‚ã€ã“ã“ã§ã¯ç‰¹ã«ä½•ã‚‚è¨˜è¿°ã—ãªã„ã€‚
// file2OriginalName ã®è¨­å®šã‚‚ handleFile2Load å†…ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€é‡è¤‡ã‚’é˜²ãã€‚


document.getElementById('saveTable2CsvBtn').addEventListener('click', saveTable2SelectedToCSV);

function saveTable2SelectedToCSV() {
  const table = document.querySelector('#table2 table');
  if (!table) {
    console.error('è¡¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    alert('ã‚¨ãƒ©ãƒ¼: è¡¨ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«2ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    return;
  }

  const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
  const idx = {
    name: headers.indexOf('å“å'),
    amount: headers.indexOf('ï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡'),
    unit: headers.indexOf('å˜ä½'),
    count: headers.indexOf('å›æ•°'),
    remark: headers.indexOf('å‚™è€ƒ')
  };

  const selectedHeader = ['å“å', 'ï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡', 'å˜ä½', 'å›æ•°', 'å‚™è€ƒ'];
  const csvRows = [selectedHeader];

  const rows = table.querySelectorAll('tr');
  rows.forEach((tr, i) => {
    if (i === 0) return;
    if (tr.style.display === 'none') return; // éè¡¨ç¤ºã®è¡Œã¯ä¿å­˜ã—ãªã„

    const cells = tr.querySelectorAll('td');
    const name = cells[idx.name]?.textContent.trim();
    const amount = cells[idx.amount]?.querySelector('input')?.value?.trim() ?? '';
    const unit = cells[idx.unit]?.textContent.trim();
    const count = cells[idx.count]?.querySelector('input')?.value?.trim() ?? '';
    const remark = idx.remark !== -1 ? cells[idx.remark]?.textContent?.trim() ?? '' : '';

    csvRows.push([name, amount, unit, count, remark]);
  });

  const csv = csvRows.map(row =>
    row.map(cell => {
      // CSVå‡ºåŠ›æ™‚ã«ã‚«ãƒ³ãƒã‚’å«ã‚€æ–‡å­—åˆ—ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚€å‡¦ç†ã‚’è¿½åŠ 
      const processedCell = String(cell).replace(/"/g, '""'); // æ—¢å­˜ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      return processedCell.includes(',') || processedCell.includes('\n') || processedCell.includes('"') ? `"${processedCell}"` : processedCell;
    }).join(',')
  ).join('\r\n');

  const now = new Date();
  const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
  const baseName = file2OriginalName || 'è¡¨2';
  const filename = `${baseName}_${timestamp}.csv`;

  const sjisArray = Encoding.convert(Encoding.stringToCode(csv), {
    to: 'SJIS',
    from: 'UNICODE'
  });
  const blob = new Blob([new Uint8Array(sjisArray)], { type: 'text/csv' });

  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}
  </script>
</body>
</html>
