<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CSV é‡‘é¡è‡ªå‹•è¨ˆç®—</title>
  <style>
body {
  font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
  background-color: #f7f9fc;
  color: #333;
  padding: 30px;
  line-height: 1.6;
}

h1 {
  font-size: 1.8em;
  color: #006c9c;
  margin-bottom: 20px;
}

table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;         /* åˆ—å¹…å›ºå®šãƒ¢ãƒ¼ãƒ‰ã§å‡ç­‰é…åˆ† */
  background-color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  margin-top: 20px;
  font-size: 14px;
}

th, td {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
  text-align: right;           /* å…¨ä½“å³æƒãˆï¼ˆæ–‡å­—åˆ—åˆ—ã¯JSã¾ãŸã¯HTMLå´ã§å·¦å¯„ã›å¯ï¼‰ */
  word-break: break-word;
}

th {
  background-color: #e3edf4;
  font-weight: bold;
  border-bottom: 2px solid #ccc;
}

/* å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ select */
th select {
  width: 100%;
  font-size: 13px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background-color: #fff;
  text-align: right;
}

/* å…¥åŠ›æ¬„ï¼ˆå›æ•°ãªã©ï¼‰ */
td input[type="number"] {
  width: 60px;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: right;
}

/* hoveræ™‚ã®å¼·èª¿ */
tr:hover td {
  background-color: #f4f8fc;
}

input[type="number"] {
  width: 70px;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
    text-align: right;
}
input[type="text"]::placeholder {
  color: #999;
}
input[type="text"] {
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  background-color: #007bb5;
  color: #fff;
  border: none;
  padding: 8px 14px;
  margin-right: 8px;
  font-size: 0.9em;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background-color: #005f8e;
}

#totalCost {
  font-size: 1.1em;
  margin-top: 15px;
  color: #444;
}

  </style>
</head>
<body>
  <h1>CSV é‡‘é¡è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>

  <!-- è³‡æä¾¡æ ¼.csv ã‚’ fetch ã§è‡ªå‹•èª­è¾¼ -->
  <p>ğŸ“„ åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆè³‡æä¾¡æ ¼.csv ã‚’è‡ªå‹•èª­è¾¼ï¼‰:</p>
  <button id="toggleTable1" style="display:none;">â–¼ è¡¨ç¤ºã—ãªã„</button>
  <div id="table1"></div>

  <!-- file2 ã¯å¾“æ¥ã©ãŠã‚Šæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <p>ğŸ“„ ä½¿ç”¨é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆfile2ï¼‰CSV:</p>
  <div id="file2-controls">
    <input type="file" id="file2" accept=".csv" />
    <button id="toggleTable2" style="display:none;">â–¼ è¡¨ã‚’è¡¨ç¤º</button>
    <button id="calcFile2"  style="display:none;">ğŸ§® è¨ˆç®—ã™ã‚‹</button>
    <button id="toggleMoneyBtn" style="display:none;">â–¶ é‡‘é¡ã‚ã‚Šã®ã¿è¡¨ç¤º</button>
  </div>

  <div id="totalCost">
    10ã‚¢ãƒ¼ãƒ«ã‚ãŸã‚Šå¤‰å‹•è²»ï¼š<span id="costPer10a">â€”</span> å††
    <button id="copyCostBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  </div>

  <div id="table2" style="display:none;"></div>
</body>
  
  <script>
  let masterData = {}; // å“å â†’ { usage, unit }
  let priceData = {}; // å“å â†’ { price, volume, unit }

window.addEventListener('DOMContentLoaded', () => {
  fetch('è³‡æä¾¡æ ¼.csv')
    .then(response => {
      if (!response.ok) throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—');
      return response.text();
    })
    .then(csvText => {
      const rows = parseCSV(csvText);

      rows.slice(1).forEach(row => {
        const name = (row[1] || '').trim(); // å“å
        const volume = parseFloat((row[2] || '').replace(/,/g, '')); // å®¹é‡
        const unit = (row[3] || '').trim(); // å˜ä½
        const price = parseFloat((row[4] || '').replace(/,/g, '')); // ä¾¡æ ¼

        if (name && !isNaN(price) && !isNaN(volume) && unit) {
          priceData[name] = { price, volume, unit };
        }
      });

      const table = createTableForFile1(rows);
      const tableDiv = document.getElementById('table1');
      tableDiv.innerHTML = '';
      tableDiv.appendChild(table);
      tableDiv.style.display = 'block';

      const toggleBtn = document.getElementById('toggleTable1');
      toggleBtn.style.display = 'inline';
      toggleBtn.textContent = 'â–¼ è¡¨ç¤ºã—ãªã„';
    })
    .catch(error => {
      alert('ã€Œè³‡æä¾¡æ ¼.csvã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      console.error(error);
    });
});


  function parseCSV(content) {
    return content
      .trim()
      .split('\n')
      .map(row => row.split(',').map(cell => cell.trim()))
      .map(row => {
        while (row[row.length - 1] === '') row.pop();
        return row;
      });
  }


function createTable(data) {
  const table = document.createElement('table');

  // é‡‘é¡åˆ—ã‚’è¿½åŠ ï¼ˆå›æ•°ã®å¾Œã‚ï¼‰
  const headerRow = data[0];
  const calcColIndex = headerRow.indexOf('å›æ•°') + 1;

  const newHeader = [...headerRow];
  newHeader.splice(calcColIndex, 0, 'é‡‘é¡');

  // ãƒ‡ãƒ¼ã‚¿è¡Œã«é‡‘é¡åˆ—ã‚’æŒ¿å…¥ï¼ˆåˆæœŸå€¤ã¯ç©ºï¼‰
  const newData = data.slice(1).map(row => {
    const newRow = [...row];
    newRow.splice(calcColIndex, 0, '');
    return newRow;
  });

  const finalData = [newHeader, ...newData];

  // å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤ä¸€è¦§
  const remarkColIndex = newHeader.indexOf('å‚™è€ƒ');
  const remarkValues = [...new Set(
    finalData.slice(1).map(row => row[remarkColIndex]).filter(v => v)
  )].sort();

  finalData.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');

    newHeader.forEach((colName, colIndex) => {
      const cellValue = row[colIndex] ?? '';
      const tag = rowIndex === 0 ? 'th' : 'td';
      const td = document.createElement(tag);
      td.style.textAlign = 'right';

      // âœ… å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆ1è¡Œç›®ãƒ»å‚™è€ƒåˆ—ï¼‰
      if (rowIndex === 0 && colIndex === remarkColIndex) {
        const select = document.createElement('select');
        select.style.width = '100%';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'â–¼ å‚™è€ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼';
        select.appendChild(defaultOption);

        remarkValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = `â–¼ ${value}`;
          select.appendChild(option);
        });

        select.addEventListener('change', function () {
          const keyword = this.value;
          const allRows = table.querySelectorAll('tr');
          allRows.forEach((r, i) => {
            if (i === 0) return;
            const cell = r.querySelectorAll('td')[remarkColIndex];
            const text = cell?.textContent?.trim() || '';
            r.style.display = keyword === '' || text === keyword ? '' : 'none';
          });
        });

        td.appendChild(select);

      // âœ… é‡‘é¡åˆ—ï¼ˆ1è¡Œç›® â†’ è¡¨ç¤ºã ã‘ï¼‰
      } else if (rowIndex === 0 && colName === 'é‡‘é¡') {
        td.textContent = 'é‡‘é¡';

      // âœ… å…¥åŠ›æ¬„ï¼ˆå›æ•°åˆ—ï¼‰
      } else if (rowIndex > 0 && colName === 'å›æ•°') {
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.value = cellValue;
        input.style.width = '60px';
        input.style.textAlign = 'right';
        td.appendChild(input);

      // âœ… é‡‘é¡åˆ—ï¼ˆåˆæœŸå€¤ã¯ â€”ï¼‰
      } else if (rowIndex > 0 && colName === 'é‡‘é¡') {
        td.textContent = 'â€”';

      // âœ… ãã®ä»–ã®ã‚»ãƒ«
      } else {
        td.textContent = cellValue;
      }

      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  return table;
}


function createTableForFile1(data) {
  const table = document.createElement('table');

  // æœ€å¤§åˆ—æ•°ã‚’ç®—å‡º
  const maxCols = Math.max(...data.map(row => row.length));

  // è²»ç›®åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆæƒ³å®šï¼šå…ˆé ­åˆ—ãŒè²»ç›®ï¼‰
  const categoryIndex = 0;

  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè²»ç›®ä¸€è¦§ã‚’å–å¾—ï¼ˆç©ºæ¬„é™¤å¤–ï¼‰
  const categoryValues = [...new Set(data.slice(1).map(row => row[categoryIndex]).filter(v => v))].sort();

  data.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');

    for (let colIndex = 0; colIndex < maxCols; colIndex++) {
      const tag = rowIndex === 0 ? 'th' : 'td';
      const td = document.createElement(tag);
      td.style.textAlign = 'right';

      if (rowIndex === 0 && colIndex === categoryIndex) {
        // ğŸ”½ è²»ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã‚’æŒ¿å…¥
        const select = document.createElement('select');
        select.style.width = '100%';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'â–¼ è²»ç›®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼';
        select.appendChild(defaultOption);

        categoryValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = `â–¼ ${value}`;
          select.appendChild(option);
        });

        select.addEventListener('change', function () {
          const keyword = this.value;
          const allRows = table.querySelectorAll('tr');
          allRows.forEach((r, i) => {
            if (i === 0) return;
            const cell = r.querySelectorAll('td')[categoryIndex];
            const text = cell?.textContent?.trim() || '';
            r.style.display = keyword === '' || text === keyword ? '' : 'none';
          });
        });

        td.appendChild(select);
      } else {
        td.textContent = row[colIndex] ?? '';
      }

      tr.appendChild(td);
    }

    table.appendChild(tr);
  });

  return table;
}

document.getElementById('toggleTable1').addEventListener('click', () => {
  const tableDiv = document.getElementById('table1');
  const toggleBtn = document.getElementById('toggleTable1');
  const isVisible = tableDiv.style.display !== 'none';
  tableDiv.style.display = isVisible ? 'none' : 'block';
  toggleBtn.textContent = isVisible ? 'â–¶ è¡¨ã‚’è¡¨ç¤º' : 'â–¼ è¡¨ç¤ºã—ãªã„';
});


  // â†“ ã“ã®ã‚ã¨ file1, file2 èª­ã¿è¾¼ã¿å‡¦ç†ãŒç¶šã

    // è¡¨ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºãƒˆã‚°ãƒ«
    document.getElementById('toggleTable1').addEventListener('click', function () {
      const tableDiv = document.getElementById('table1');
      const isVisible = tableDiv.style.display !== 'none';
      tableDiv.style.display = isVisible ? 'none' : 'block';
      this.textContent = isVisible ? 'â–¶ è¡¨ã‚’è¡¨ç¤º' : 'â–¼ è¡¨ç¤ºã—ãªã„';
    });

    // file1ï¼šäºˆç´„ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
document.getElementById('file1').addEventListener('change', function (e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function () {
    const rows = parseCSV(reader.result);

    rows.slice(1).forEach(row => {
      const headers = rows[0];
const nameIdx = headers.indexOf('å“å');
const volumeIdx = headers.indexOf('å®¹é‡');
const unitIdx = headers.indexOf('å˜ä½');
const priceIdx = headers.indexOf('ä¾¡æ ¼');

rows.slice(1).forEach(row => {
  const name = (row[nameIdx] || '').trim();
  const volume = parseFloat((row[volumeIdx] || '').replace(/,/g, ''));
  const unit = (row[unitIdx] || '').trim();
  const price = parseFloat((row[priceIdx] || '').replace(/,/g, ''));

  if (name && !isNaN(price) && !isNaN(volume) && unit) {
    priceData[name] = { price, volume, unit };
  }
});

      const volume = parseFloat((row[2] || '').replace(/,/g, '')); // å®¹é‡
      const unit = (row[3] || '').trim(); // å˜ä½ï¼ˆã“ã‚ˆã¿è¡¨ç¤ºï¼‰
      const price = parseFloat((row[4] || '').replace(/,/g, '')); // äºˆç´„å‚è€ƒä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰

      if (name && !isNaN(price) && !isNaN(volume) && unit) {
        priceData[name] = { price, volume, unit }; // ğŸŒŸ å˜ä½ã‚’è¿½åŠ 
      }
    });

    const table = createTableForFile1(rows);
    const tableDiv = document.getElementById('table1');
    tableDiv.innerHTML = '';
    tableDiv.appendChild(table);
    tableDiv.style.display = 'block';

    const toggleBtn = document.getElementById('toggleTable1');
    toggleBtn.style.display = 'inline';
    toggleBtn.textContent = 'â–¼ è¡¨ç¤ºã—ãªã„';
  };

  reader.readAsText(file, 'Shift_JIS');
});



// file2èª­ã¿è¾¼ã¿
document.getElementById('file2').addEventListener('change', function (e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function () {
    const rows = parseCSV(reader.result).filter(r => r.length > 0 && r[0]);

    if (rows.length === 0) {
      alert("âš ï¸ file2 ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼");
      return;
    }

    const header = rows[0];
    const body = rows.slice(1).map(row => {
      const name = row[0];
      const currentUsage = row[1];
      const currentUnit = row[2];
      const fallback = masterData[name] || {};

      row[1] = currentUsage || (fallback.usage != null ? fallback.usage : '');
      row[2] = currentUnit || fallback.unit || '';

      return row;
    });

    const table = createTable([header, ...body]);
    const container = document.getElementById('table2');
    container.innerHTML = '';
    container.appendChild(table);
    container.style.display = 'block';

    // âœ… é‡‘é¡è¡¨ç¤ºã‚’åˆæœŸåŒ–ï¼ˆâ† è¿½åŠ ï¼‰
    const costSpan = document.getElementById('costPer10a');
    if (costSpan) {
      costSpan.textContent = 'â€”';
    }

    // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚‚ã“ã“ã§åˆ¶å¾¡ï¼
    const toggleBtn = document.getElementById('toggleTable2');
    toggleBtn.style.display = 'inline-block';
    toggleBtn.textContent = 'â–¼ è¡¨ç¤ºã—ãªã„';

    const calcBtn = document.getElementById('calcFile2');
    calcBtn.style.display = 'inline-block';
    
	    // âœ… ğŸ”½ ã“ã‚Œã‚’è¿½åŠ ï¼
	const moneyBtn = document.getElementById('toggleMoneyBtn');
	moneyBtn.style.display = 'inline-block';
  };

  reader.readAsText(file, 'Shift_JIS');
});

// è¡¨ç¤ºãƒ»éè¡¨ç¤ºãƒˆã‚°ãƒ«
document.getElementById('toggleTable2').addEventListener('click', function () {
  const tableDiv = document.getElementById('table2');
  const isVisible = tableDiv.style.display !== 'none';
  tableDiv.style.display = isVisible ? 'none' : 'block';

  this.textContent = isVisible ? 'â–¶ è¡¨ã‚’è¡¨ç¤º' : 'â–¼ è¡¨ç¤ºã—ãªã„';

  // è¨ˆç®—ãƒœã‚¿ãƒ³ã‚‚é€£å‹•ã—ã¦è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  const calcBtn = document.getElementById('calcFile2');
  calcBtn.style.display = isVisible ? 'none' : 'inline-block';
});

document.getElementById('calcFile2').addEventListener('click', function () {
  const table = document.querySelector('#table2 table');
  if (!table) {
    console.warn("âš ï¸ è¡¨ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
    return;
  }

  const headers = Array.from(table.querySelector('tr').querySelectorAll('th')).map(th => th.textContent);
  const idx = {
    name: headers.indexOf('å“å'),
    amountPer10a: headers.indexOf('ï¼‘ï¼ã‚¢ãƒ¼ãƒ«é‡'),
    unit: headers.indexOf('å˜ä½'),
    count: headers.indexOf('å›æ•°'),
    price: headers.indexOf('é‡‘é¡')
  };

  const rows = Array.from(table.querySelectorAll('tr')).slice(1); // ãƒ‡ãƒ¼ã‚¿è¡Œã ã‘
  let total = 0;

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');

    const name = cells[idx.name]?.textContent?.trim();
    const amountPer10a = parseFloat(cells[idx.amountPer10a]?.textContent || 0);
    const unit = cells[idx.unit]?.textContent?.trim();
    const count = parseFloat(cells[idx.count]?.querySelector('input')?.value || 0);

    const priceCell = cells[idx.price];

    const info = priceData[name];
    if (!info || isNaN(info.price) || isNaN(info.volume)) {
      priceCell.textContent = 'â€•';
      return;
    }

    if (unit !== info.unit) {
      priceCell.textContent = 'å˜ä½ä¸ä¸€è‡´';
      return;
    }

    const unitPrice = info.price / info.volume;
    const amount = unitPrice * amountPer10a * count;
    priceCell.textContent = amount.toLocaleString();

    // åˆè¨ˆé›†è¨ˆï¼ˆå›æ•°0é™¤å¤–ãƒ»æ•°å€¤åˆ¤å®šï¼‰
    if (count > 0 && !isNaN(amount)) {
      total += amount;
    }
  });

  const costSpan = document.getElementById('costPer10a');
  if (costSpan) {
    costSpan.textContent = Math.round(total).toLocaleString(); // â† å°æ•°ãªã—ã‚‚å¯¾å¿œæ¸ˆã¿
  }
});

let showOnlyPriced = false;

document.getElementById('toggleMoneyBtn')?.addEventListener('click', () => {
  const table = document.querySelector('#table2 table');
  if (!table) return;

  const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
  const priceIndex = headers.indexOf('é‡‘é¡');
  if (priceIndex === -1) return;

  showOnlyPriced = !showOnlyPriced;

  const rows = table.querySelectorAll('tr');
  rows.forEach((tr, i) => {
    if (i === 0) return;
    const text = tr.querySelectorAll('td')[priceIndex]?.textContent.trim() ?? '';
    const isValid = /^\d[\d,]*$/.test(text); // æ•°å€¤ãƒã‚§ãƒƒã‚¯

    tr.style.display = (!showOnlyPriced || isValid) ? '' : 'none';
  });

  document.getElementById('toggleMoneyBtn').textContent =
    showOnlyPriced ? 'â–¼ å…¨ã¦è¡¨ç¤ºã™ã‚‹' : 'â–¶ é‡‘é¡ã‚ã‚Šã®ã¿è¡¨ç¤º';
});

//å¤‰å‹•è²»ã®ã‚³ãƒ”ãƒ¼
document.getElementById('copyCostBtn')?.addEventListener('click', () => {
  const raw = document.getElementById('costPer10a')?.textContent?.trim();
  if (raw && raw !== 'â€•') {
    const numericValue = raw.replace(/,/g, '');
    navigator.clipboard.writeText(numericValue)
      .then(() => alert('å¤‰å‹•è²»ã®æ•°å€¤ã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))
      .catch(() => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'));
  }
});

// ğŸ’° é‡‘é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³æ©Ÿèƒ½
document.querySelectorAll('#moneyFilter button').forEach(btn => {
  btn.addEventListener('click', () => {
    const table = document.querySelector('#table2 table');
    if (!table) return;

    const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
    const priceIndex = headers.indexOf('é‡‘é¡');
    if (priceIndex === -1) return;

    const mode = btn.dataset.filter;
    const rows = table.querySelectorAll('tr');

    rows.forEach((tr, i) => {
      if (i === 0) return; // ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å¸¸ã«è¡¨ç¤º

      const cells = tr.querySelectorAll('td');
      const text = cells[priceIndex]?.textContent.trim() ?? '';
      const isNumeric = /^\d[\d,]*$/.test(text);
      const isEmpty = text === 'â€•' || text === '' || text === 'â€”';

      let show = true;
      if (mode === 'has') show = isNumeric;
      else if (mode === 'none') show = isEmpty;

      tr.style.display = show ? '' : 'none';
    });
  });
});

  </script>
</body>
</html>
